{% extends 'home/base.html' %}

{% block title %}Cart | By.Notti{% endblock %}

{% block content %}
<div class="row gx-4 cart">

  <div class="col-lg-8 mb-4" id="cartItems">
    {% if cart_items %}
      {% for item in cart_items %}
      <div class="cart-item p-3 border rounded-3 mb-3 d-flex align-items-center" data-harga="{{ item.price }}">
        <img
          src="{{ url_for('static', filename='images/' ~ item.image) }}"
          alt="{{ item.product_name }}"
          class="img-fluid rounded me-3 object-fit-cover"
          style="width: 100px; height: 100px"
        />
        <div class="flex-grow-1 d-flex justify-content-between">
          <div>
            <h5 class="mb-2 text-primary fw-bold">{{ item.product_name }}</h5>
            <div class="d-flex align-items-center">
              <span class="text-muted me-3 d-none d-md-block">Quantity</span>
              <div class="d-flex align-items-center border-number">
                <button class="minus-btn" onclick="updateQuantity('minus', {{ item.id }})">-</button>
                <p class="jumlah-item">{{ item.quantity }}</p>
                <button class="plus-btn" onclick="updateQuantity('plus', {{ item.id }})">+</button>
              </div>
            </div>
          </div>
          <div class="d-flex flex-column align-items-end justify-content-between">
            <h5 class="mb-2 text-primary fw-bold">
              <span class="harga-item">Rp. {{ '{:,.0f}'.format(item.price | int) }}</span>
            </h5>
            <button class="btn btn-danger btn-sm hapus-item" onclick="removeItem({{ item.id }})">
              <i class="bx bx-trash"></i>
            </button>
          </div>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <p>Your cart is empty. Start shopping now!</p>
    {% endif %}
  </div>

  <div class="col-lg-4" id="orderSummary">
    <div class="cart-summary p-4 border rounded-3 bg-light shadow">
      <h4 class="text-primary mb-4 fw-bold">Ringkasan Pesanan</h4>

      <div class="mb-3">
        <label for="customerName" class="form-label fw-bold">Nama</label>
        <input type="text" id="customerName" class="form-control" placeholder="Masukkan Nama Anda" required>
      </div>

      <div class="mb-3">
        <label for="customerAddress" class="form-label fw-bold">Alamat</label>
        <textarea id="customerAddress" class="form-control" rows="3" placeholder="Masukkan Alamat Anda" required></textarea>
      </div>

      <div class="d-flex justify-content-between mb-4">
        <span class="fw-bold text-primary">Total</span>
        <span class="fw-bold text-primary" id="total">Rp. 50.000</span>
      </div>

      <button id="placeOrder" class="btn btn-success w-100 rounded-pill">Pesan Sekarang Via WhatsApp</button>
    </div>
  </div>
</div>

<script>
  // Fungsi Pemesanan (tidak berubah dari versi Anda)
  function placeOrder() {
    const customerName = document.getElementById('customerName').value.trim();
    const customerAddress = document.getElementById('customerAddress').value.trim();

    if (!customerName || !customerAddress) {
        alert('Nama dan alamat harus diisi!');
        return;
    }

    const orderData = {
        name: customerName,
        address: customerAddress,
        products: [],
        total_price: parseInt(document.getElementById('total').innerText.replace('Rp. ', '').replace('.', ''))
    };

    document.querySelectorAll('.cart-item').forEach(function(item) {
        const product = {
            name: item.querySelector('.text-primary').innerText.trim(),
            quantity: parseInt(item.querySelector('.jumlah-item').innerText.trim()),
            price: parseInt(item.getAttribute('data-harga'))
        };
        orderData.products.push(product);
    });

    $.ajax({
        type: 'POST',
        url: '/place_order',
        data: JSON.stringify(orderData),
        contentType: 'application/json',
        success: function(response) {
            alert('Pesanan berhasil dibuat!');
            window.location.reload();
        },
        error: function(error) {
            console.error('Error saat memesan', error);
            alert('Gagal membuat pesanan, coba lagi nanti.');
        }
    });
  }

  document.getElementById('placeOrder').addEventListener('click', placeOrder);
</script>
{% endblock %}
